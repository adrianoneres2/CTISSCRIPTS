/*

 Identifica se existem projetos de centros participantes ou coparticipantes com problemas nos registros de grupos.

 A consulta é a partir do centro coordenador.

*/


SET SERVEROUTPUT ON;
DECLARE
  V_DESENHO_ESTUDO_COORD NUMBER(9);
  V_DESENHO_ESTUDO_PARTC NUMBER(9);
  
  V_GRUPO_DESENHO_COORD NUMBER(9);
  V_GRUPO_DESENHO_PARTC NUMBER(9);
BEGIN
  FOR I IN(SELECT  NU_CAAE,
                    CO_SEQ_PROJETO,
                    CO_PROJETO_ORIGEM
            FROM DBPLATAFORMABR.TB_PROJETO
            WHERE CO_PROJETO_ORIGEM IN(SELECT CO_SEQ_PROJETO
                                    FROM DBPLATAFORMABR.TB_PROJETO
                                    START WITH CO_SEQ_PROJETO = (SELECT MIN(CO_SEQ_PROJETO)
                                                                  FROM DBPLATAFORMABR.TB_PROJETO 
								   --- INFORME O CAAE OU O CÓDIGO DO CENTRO COOORDENADOR
                                                                  START WITH CO_SEQ_PROJETO = 5963---(SELECT MIN(CO_SEQ_PROJETO) FROM DBPLATAFORMABR.TB_PROJETO WHERE NU_CAAE = '32517514.0.2030.5335')
                                                                  CONNECT BY  CO_SEQ_PROJETO = PRIOR CO_ORIGEM_EMENDA)
                                    CONNECT BY PRIOR CO_SEQ_PROJETO = CO_ORIGEM_EMENDA)
            order by co_seq_projeto)
 LOOP
  
  -- VERIFICA QUANTIDADE DE DESENHO ESTUDO PARA O COORDENADOR.
  SELECT COUNT(*) INTO V_DESENHO_ESTUDO_COORD FROM DBPLATAFORMABR.TB_DESENHO_ESTUDO WHERE CO_PROJETO = I.CO_PROJETO_ORIGEM;
  -- VERIFICA QUANTIDADE DE DESENHO ESTUDO PARA PARTICIPANTE OU COPARTICIPATE.
  SELECT COUNT(*) INTO V_DESENHO_ESTUDO_PARTC FROM DBPLATAFORMABR.TB_DESENHO_ESTUDO WHERE CO_PROJETO = I.CO_SEQ_PROJETO;

  IF (V_DESENHO_ESTUDO_COORD != V_DESENHO_ESTUDO_PARTC) THEN 
    DBMS_OUTPUT.PUT_LINE('DIFERENÇA DE DESENHO ESTUDO ENTRE O CENTRO COORDENADOR : '||I.CO_PROJETO_ORIGEM||' E O CENTRO PARTICIPANTE/COPARTICIPANTE : '||I.CO_SEQ_PROJETO);
  ELSE
    -- VERIFICA QUANTIDADE DE GRUPOS DESENHO PARA O COORDENADOR.
    SELECT COUNT(*) INTO V_GRUPO_DESENHO_COORD FROM DBPLATAFORMABR.TB_GRUPO_DESENHO WHERE co_desenho_estudo IN(
    SELECT co_seq_desenho_estudo FROM DBPLATAFORMABR.TB_DESENHO_ESTUDO WHERE CO_PROJETO = I.CO_PROJETO_ORIGEM);
    
    -- VERIFICA QUANTIDADE DE GRUPO DESENHO PARA PARTICIPANTE OU COPARTICIPATE.
    SELECT COUNT(*) INTO V_GRUPO_DESENHO_PARTC FROM DBPLATAFORMABR.TB_GRUPO_DESENHO WHERE co_desenho_estudo IN(
    SELECT co_seq_desenho_estudo FROM DBPLATAFORMABR.TB_DESENHO_ESTUDO WHERE CO_PROJETO = I.CO_SEQ_PROJETO);
    
      IF(V_GRUPO_DESENHO_COORD != V_GRUPO_DESENHO_PARTC)THEN
        DBMS_OUTPUT.PUT_LINE('DIFERENÇA DE GRUPO DESENHO ENTRE O CENTRO COORDENADOR : '||I.CO_PROJETO_ORIGEM||' E O CENTRO PARTICIPANTE/COPARTICIPANTE : '||I.CO_SEQ_PROJETO);
      END IF;
  END IF;
 END LOOP; ----- FIM LOOP I
END;
